<div class="max-w-2xl mx-auto mt-10 p-6 bg-gray-800 text-white rounded-xl shadow-lg">
  <h2 class="text-3xl font-bold mb-6 text-center">Mon Profil</h2>

  <!-- Global feedback -->
  <div *ngIf="successMsg" class="mb-4 rounded bg-green-600/20 border border-green-500 px-4 py-2">
    {{ successMsg }}
  </div>
  <div *ngIf="errorMsg" class="mb-4 rounded bg-red-600/20 border border-red-500 px-4 py-2">
    {{ errorMsg }}
  </div>

  <!-- Loader -->
  <div *ngIf="isLoadingProfile" class="text-center text-sm opacity-80 mb-4">Chargement du profil...</div>

  <!-- Informations du compte -->
  <section>
    <h3 class="text-xl font-semibold mb-3">Informations du compte</h3>

    <!-- View mode -->
    <div *ngIf="!editMode; else editForm" class="space-y-3">
      <div>
        <label class="block text-sm opacity-80">Nom d'utilisateur</label>
        <p class="text-lg font-medium">{{ (originalUser?.username) || '—' }}</p>
      </div>
      <div>
        <label class="block text-sm opacity-80">Adresse email</label>
        <p class="text-lg font-medium">{{ (originalUser?.email) || '—' }}</p>
      </div>

      <button class="mt-4 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 rounded disabled:opacity-50"
        (click)="enableEdit()" [disabled]="isLoadingProfile">
        Modifier mes informations
      </button>
    </div>

    <!-- Edit mode -->
    <ng-template #editForm>
      <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" class="space-y-4">
        <div>
          <label class="block text-sm">Nom d'utilisateur</label>
          <input type="text" formControlName="username" class="w-full p-2 rounded text-black" autocomplete="username" />
          <p class="mt-1 text-sm text-red-300" *ngIf="f.username.touched && f.username.invalid">
            <span *ngIf="f.username.errors?.['required']">Le nom d'utilisateur est requis.</span>
            <span *ngIf="f.username.errors?.['minlength']">Minimum 3 caractères.</span>
          </p>
        </div>

        <div>
          <label class="block text-sm">Adresse email</label>
          <input type="email" formControlName="email" class="w-full p-2 rounded text-black" autocomplete="email" />
          <p class="mt-1 text-sm text-red-300" *ngIf="f.email.touched && f.email.invalid">
            <span *ngIf="f.email.errors?.['required']">L'email est requis.</span>
            <span *ngIf="f.email.errors?.['email']">Format d'email invalide.</span>
          </p>
        </div>

        <div class="flex gap-2 mt-4">
          <button type="submit" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded disabled:opacity-50"
            [disabled]="profileForm.invalid || isSavingProfile">
            <span *ngIf="!isSavingProfile">Enregistrer</span>
            <span *ngIf="isSavingProfile">Enregistrement…</span>
          </button>
          <button type="button" (click)="cancelEdit()" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded">
            Annuler
          </button>
        </div>
      </form>
    </ng-template>
  </section>

  <hr class="my-6 border-gray-600" />

  <!-- Changement de mot de passe -->
  <section>
    <h3 class="text-xl font-semibold mb-4">Changer le mot de passe</h3>

    <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="space-y-4">
      <div>
        <label class="block text-sm">Ancien mot de passe</label>
        <input type="password" formControlName="oldPassword" class="w-full p-2 rounded text-black"
          autocomplete="current-password" />
        <p class="mt-1 text-sm text-red-300" *ngIf="p.oldPassword.touched && p.oldPassword.invalid">
          L'ancien mot de passe est requis.
        </p>
      </div>

      <div>
        <label class="block text-sm">Nouveau mot de passe</label>
        <input type="password" formControlName="newPassword" class="w-full p-2 rounded text-black"
          autocomplete="new-password" />
        <p class="mt-1 text-sm text-red-300" *ngIf="p.newPassword.touched && p.newPassword.invalid">
          <span *ngIf="p.newPassword.errors?.['required']">Le nouveau mot de passe est requis.</span>
          <span *ngIf="p.newPassword.errors?.['minlength']">Minimum 8 caractères.</span>
        </p>
      </div>

      <div>
        <label class="block text-sm">Confirmer le nouveau mot de passe</label>
        <input type="password" formControlName="confirmPassword" class="w-full p-2 rounded text-black"
          autocomplete="new-password" />
        <p class="mt-1 text-sm text-red-300"
          *ngIf="(passwordForm.touched || p.confirmPassword.touched) && passwordForm.errors?.['fieldsMismatch']">
          Les mots de passe ne correspondent pas.
        </p>
      </div>

      <button type="submit" class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded disabled:opacity-50"
        [disabled]="passwordForm.invalid || isChangingPassword">
        <span *ngIf="!isChangingPassword">Mettre à jour le mot de passe</span>
        <span *ngIf="isChangingPassword">Mise à jour…</span>
      </button>
    </form>
  </section>
</div>